# メール送信機能の実装

## 概要

進捗ステータスが「応募済み」の際に、企業へ求職者の応募情報をメール送信する機能を実装しました。

## 機能詳細

### 送信方法
- 進捗モーダルで以下の場合に「企業へメールを送る」ボタンが表示されます：
  - **現在のステータスが「応募済み」で「書類選考中」に変更する時**
- ボタンをクリックすることで、企業にメール送信されます
- ステータス更新とメール送信は独立しており、必要に応じてメールのみ送信できます
- 候補者詳細ページ、進捗一覧ページ、進捗詳細ページすべてで動作

### メール内容
メールには以下の情報が含まれます：
- 求人タイトル
- 候補者名
- 候補者の電話番号
- 候補者のメールアドレス
- 先生からのコメント（履歴書情報として使用）
- 担当者が入力した備考

**送信先:**
- TO: 企業のメールアドレス
- BCC: `sales+matcha@super-shift.co.jp` (営業チームにも自動送信)

### メール履歴機能
送信したメールは自動的にFirestoreの`emailHistory`コレクションに保存されます。履歴には以下の情報が記録されます：
- メール送信先、件名、本文
- 関連するmatchId、candidateId、jobId、companyId
- 送信者のユーザーID
- 送信日時とステータス

## セットアップ手順

### 1. Resendアカウントの作成

1. [Resend](https://resend.com)にアクセスしてアカウントを作成
2. ダッシュボードからAPIキーを取得
3. ドメイン認証を行う（本番環境用）

### 2. 環境変数の設定

`.env.local`ファイルに以下の環境変数を追加：

```bash
# Resend Email Configuration
RESEND_API_KEY=re_xxxxxxxxxxxxxxxxxx
RESEND_FROM_EMAIL=noreply@yourdomain.com
```

**開発環境での注意事項：**
- `RESEND_FROM_EMAIL`が未設定の場合、デフォルトで`onboarding@resend.dev`が使用されます
- 本番環境では必ず認証済みドメインのメールアドレスを設定してください

### 3. Vercelへのデプロイ

Vercelの環境変数設定で以下を追加：

```
RESEND_API_KEY: [ResendのAPIキー]
RESEND_FROM_EMAIL: [送信元メールアドレス]
```

## ファイル構成

```
src/
├── app/
│   └── api/
│       └── send-candidate-email/
│           └── route.ts              # メール送信APIエンドポイント
├── components/
│   ├── email/
│   │   └── EmailHistoryList.tsx     # メール履歴表示コンポーネント
│   └── matches/
│       └── StatusUpdateDialog.tsx    # 修正: メール送信処理を追加
├── lib/
│   └── email.ts                      # メール送信用ユーティリティ関数
├── types/
│   └── email.ts                      # メール履歴の型定義
└── app/
    ├── candidates/[id]/page.tsx      # 修正: メール送信用情報を渡す
    ├── progress/page.tsx             # 修正: メール送信用情報を渡す
    └── progress/[id]/page.tsx        # 修正: メール送信用情報を渡す
```

## 技術スタック

- **Resend**: Next.js公式推奨のメール送信サービス
- **Next.js API Routes**: サーバーサイドでメール送信を実行
- **TypeScript**: 型安全なメール送信処理

## 使い方

1. **進捗モーダルを開く**
   - 候補者詳細ページ、進捗一覧、または進捗詳細ページから進捗モーダルを開きます

2. **ステータスを「書類選考中」に変更**
   - 現在のステータスが「応募済み」の場合、次のステータス選択で「書類選考中」を選択します
   - 選択すると、モーダル下部に「企業へメールを送る」ボタンが表示されます

3. **メール送信（任意）**
   - 「企業へメールを送る」ボタンをクリックしてメールを送信
   - メール送信は任意で、必要に応じて後から送信することも可能です

4. **ステータス更新**
   - 「更新」ボタンをクリックしてステータスを保存します

**重要:** ステータス更新とメール送信は独立した操作です。「更新」ボタンを押してもメールは自動送信されません。

開発環境では`onboarding@resend.dev`が使用されますが、本番環境では認証済みドメインのメールアドレスを設定してください！

## メール履歴の表示

送信したメール履歴を確認するには、`EmailHistoryList`コンポーネントを使用します。

```tsx
import { EmailHistoryList } from '@/components/email/EmailHistoryList'

// 特定のマッチに関連するメール履歴を表示
<EmailHistoryList matchId={matchId} />

// 特定の候補者に関連するメール履歴を表示
<EmailHistoryList candidateId={candidateId} />

// 特定の求人に関連するメール履歴を表示
<EmailHistoryList jobId={jobId} />

// 特定の企業に関連するメール履歴を表示
<EmailHistoryList companyId={companyId} />
```

メール履歴には以下の情報が表示されます：
- 件名
- 送信先メールアドレス
- メール本文
- 送信日時
- 送信ステータス（送信済み/送信失敗）
- BCC送信先（sales+matcha@super-shift.co.jp）

## トラブルシューティング

### メールが送信されない場合

1. **環境変数の確認**
   ```bash
   # 環境変数が正しく設定されているか確認
   echo $RESEND_API_KEY
   ```

2. **企業のメールアドレスが設定されているか確認**
   - 企業マスタで`email`フィールドが入力されている必要があります

3. **Resendのログを確認**
   - [Resendダッシュボード](https://resend.com/emails)でメール送信履歴を確認

4. **ブラウザのコンソールログを確認**
   - ステータス更新時にエラーが表示されていないか確認

### よくあるエラー

**エラー: "メール送信に失敗しました"**
- Resend APIキーが正しく設定されているか確認
- ネットワーク接続を確認

**エラー: "メールアドレスが必要です"**
- 企業の`email`フィールドが空の場合に発生
- 企業マスタでメールアドレスを設定してください

## 今後の拡張案

- [ ] HTMLメールテンプレートの作成
- [ ] 添付ファイル（履歴書PDF等）の対応
- [ ] メール送信履歴の記録
- [ ] メール送信失敗時のリトライ機能
- [ ] 企業ごとのメールテンプレートカスタマイズ
